<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5">
    <title>åå°ç®¡ç† | ç™¾å¤œ</title>
    <meta name="description" content="SYSUæ•°å­¦ç³»å¤§ä¸‰åœ¨è¯»ï¼ŒäºŒæ¬¡å…ƒçˆ±å¥½è€…ï¼ŒæŠ€æœ¯åšå®¢">
    <meta name="keywords" content="ä¸ªäººåšå®¢,å¼€å‘è€…,æ•°å­¦,ç¼–ç¨‹,äºŒæ¬¡å…ƒ">
    <meta name="format-detection" content="telephone=no">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
    
    <!-- ä¿æŒåŸCSSä¸å˜ï¼Œæ·»åŠ ä¸€äº›ç®¡ç†ç•Œé¢ç‰¹æœ‰çš„æ ·å¼ -->
    <style>
        /* åŸæœ‰CSSä¿æŒä¸å˜ï¼Œæ·»åŠ ä»¥ä¸‹æ–°æ ·å¼ */
        
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .github-auth-card {
            max-width: 400px;
            width: 100%;
            background: rgba(25, 30, 40, 0.95);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            border: 1px solid rgba(103, 81, 185, 0.5);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .auth-icon {
            font-size: 4rem;
            color: #6751b9;
            margin-bottom: 20px;
        }
        
        .auth-title {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            color: #a0aec0;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .auth-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px 30px;
            background: #24292e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .auth-btn:hover {
            background: #2c3138;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(36, 41, 46, 0.3);
        }
        
        .auth-btn:active {
            transform: translateY(0);
        }
        
        .auth-note {
            font-size: 12px;
            color: #a0aec0;
            line-height: 1.5;
        }
        
        .user-info-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(103, 81, 185, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(103, 81, 185, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(103, 81, 185, 0.5);
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(25, 30, 40, 0.95);
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        
        .sync-status.success {
            border-color: #10b981;
            color: #10b981;
        }
        
        .sync-status.error {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .sync-status.warning {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 20, 30, 0.6);
            color: #e8eaed;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: rgba(103, 81, 185, 0.2);
            border-color: rgba(103, 81, 185, 0.5);
        }
        
        .data-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(15, 20, 30, 0.6);
            border-radius: 8px;
        }
        
        .data-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8a74f9;
            margin-bottom: 5px;
        }
        
        .data-stat-label {
            font-size: 0.85rem;
            color: #a0aec0;
        }
        
        .repo-selector {
            margin-top: 15px;
        }
        
        .repo-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(15, 20, 30, 0.6);
            border: 1px solid rgba(103, 81, 185, 0.3);
            color: #e8eaed;
            font-size: 14px;
        }
        
        .repo-select:focus {
            outline: none;
            border-color: #6751b9;
        }
    </style>
</head>

<body>
    <!-- æˆæƒç™»å½•ç•Œé¢ -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="github-auth-card">
            <div class="auth-icon">
                <i class="fa fa-github"></i>
            </div>
            <h2 class="auth-title">GitHub æˆæƒ</h2>
            <p class="auth-subtitle">
                éœ€è¦ GitHub æˆæƒæ¥ç®¡ç†ä½ çš„æ•°æ®<br>
                æ•°æ®å°†å®‰å…¨å­˜å‚¨åœ¨ä½ çš„ GitHub Issues ä¸­
            </p>
            <button class="auth-btn" onclick="githubLogin()">
                <i class="fa fa-github"></i> ä½¿ç”¨ GitHub ç™»å½•
            </button>
            <p class="auth-note">
                æˆæƒåï¼Œä½ å¯ä»¥åœ¨ä½ çš„ GitHub ä»“åº“ Issues ä¸­<br>
                æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ•°æ®è®°å½•
            </p>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <p style="color: #a0aec0; font-size: 12px; margin-bottom: 10px;">æµ‹è¯•æ¨¡å¼ï¼ˆå¼€å‘ç”¨ï¼‰ï¼š</p>
                <button class="action-btn" onclick="useTestToken()">
                    <i class="fa fa-key"></i> ä½¿ç”¨æµ‹è¯• Token
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="app-container" style="display: none;">
        <div id="body-wrap">
            <!-- å¯¼èˆªæ  -->
            <nav>
                <div id="site-title">
                    <span class="blogtitle">åå°ç®¡ç† | ç™¾å¤œ</span>
                </div>
                <div style="position: absolute; top: 10px; right: 20px;">
                    <div class="user-info-bar" id="user-info">
                        <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </nav>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="layout_container">
                <!-- ä¾§è¾¹æ  -->
                <div class="aside_content">
                    <!-- ä¸ªäººèµ„æ–™å¡ç‰‡ -->
                    <div class="card profile-card">
                        <div class="profile-avatar">
                            <img src="https://images3.alphacoders.com/135/thumb-1920-1358482.png" alt="å¤´åƒ">
                        </div>
                        <h2 class="profile-name">æ‘¸é±¼çˆ±å¥½è€…</h2>
                        <p class="profile-bio">SYSUæ•°å­¦ç³»å¤§ä¸‰åœ¨è¯»<br>äºŒæ¬¡å…ƒçˆ±å¥½è€… | å‰ç«¯å¼€å‘è€…<br>æ°¸è¿œä¿æŒæ±‚çŸ¥æ¬²</p>
                        
                        <div class="profile-tags">
                            <span class="tag">æ•°å­¦</span>
                            <span class="tag">ç¼–ç¨‹</span>
                            <span class="tag">äºŒæ¬¡å…ƒ</span>
                            <span class="tag">åŠ¨æ¼«</span>
                            <span class="tag">æ¸¸æˆ</span>
                        </div>
                        
                        <div class="social-links">
                            <a href="https://github.com" class="social-link" target="_blank">
                                <i class="fa fa-github"></i>
                            </a>
                            <a href="#" class="social-link" target="_blank">
                                <i class="fa fa-weibo"></i>
                            </a>
                            <a href="#" class="social-link" target="_blank">
                                <i class="fa fa-bilibili"></i>
                            </a>
                            <a href="#" class="social-link" target="_blank">
                                <i class="fa fa-zhihu"></i>
                            </a>
                        </div>
                    </div>

                    <!-- ä»“åº“é€‰æ‹© -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-database"></i>
                            </div>
                            <h3 class="card-title">æ•°æ®ä»“åº“</h3>
                        </div>
                        <div class="repo-selector">
                            <select class="repo-select" id="repo-select">
                                <option value="">é€‰æ‹©ä»“åº“...</option>
                                <!-- ä»“åº“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="data-stats">
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-thoughts">0</div>
                                <div class="data-stat-label">æƒ³æ³•è®°å½•</div>
                            </div>
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-pomodoros">0</div>
                                <div class="data-stat-label">ç•ªèŒ„é’Ÿ</div>
                            </div>
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-moods">0</div>
                                <div class="data-stat-label">å¿ƒæƒ…è®°å½•</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="loadAllData()">
                                <i class="fa fa-refresh"></i> åˆ·æ–°æ•°æ®
                            </button>
                            <button class="action-btn" onclick="exportData()">
                                <i class="fa fa-download"></i> å¯¼å‡ºæ•°æ®
                            </button>
                        </div>
                    </div>

                    <!-- å¿ƒæƒ…ç¼–è¾‘å¡ç‰‡ -->
                    <div class="card mood-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-heart"></i>
                            </div>
                            <h3 class="card-title">ä»Šæ—¥å¿ƒæƒ…</h3>
                        </div>
                        <div 
                            class="mood-content" 
                            id="mood-editor" 
                            contenteditable="true"
                            data-placeholder="ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…..."
                        >ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...</div>
                        <div class="mood-actions">
                            <button class="mood-btn" onclick="clearMood()">
                                <i class="fa fa-trash"></i> æ¸…ç©º
                            </button>
                            <button class="mood-btn mood-btn-primary" onclick="saveMood()">
                                <i class="fa fa-save"></i> ä¿å­˜åˆ° GitHub
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ä¸»å†…å®¹åŒº -->
                <div class="main_content">
                    <!-- éŸ³ä¹æ’­æ”¾å™¨å¡ç‰‡ -->
                    <div class="card music-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-music"></i>
                            </div>
                            <h3 class="card-title">å­¦ä¹ éŸ³ä¹</h3>
                        </div>
                        <div id="aplayer"></div>
                    </div>

                    <!-- ç•ªèŒ„é’ŸåŠŸèƒ½å¡ç‰‡ -->
                    <div class="card pomodoro-card">
                        <div class="pomodoro-header">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <h3 class="card-title">å­¦æœ¯ç•ªèŒ„é’Ÿ</h3>
                            </div>
                            <div class="timer-status" id="timer-status">å‡†å¤‡å¼€å§‹</div>
                        </div>
                        
                        <div class="pomodoro-timer">
                            <div class="timer-display" id="timer-display">25:00</div>
                        </div>
                        
                        <div class="controls-grid">
                            <button class="btn btn-primary" id="start-btn">
                                <i class="fa fa-play"></i> å¼€å§‹ä¸“æ³¨
                            </button>
                            <button class="btn btn-secondary" id="pause-btn" style="display:none">
                                <i class="fa fa-pause"></i> æš‚åœ
                            </button>
                            <button class="btn btn-secondary" id="reset-btn">
                                <i class="fa fa-refresh"></i> é‡ç½®
                            </button>
                            <button class="btn btn-secondary btn-small" id="short-break">
                                <i class="fa fa-coffee"></i> çŸ­ä¼‘æ¯
                            </button>
                            <button class="btn btn-secondary btn-small" id="long-break">
                                <i class="fa fa-bed"></i> é•¿ä¼‘æ¯
                            </button>
                        </div>
                        
                        <div class="pomodoro-history">
                            <h4 class="history-title">ä»Šæ—¥ä¸“æ³¨è®°å½•</h4>
                            <div class="history-list" id="history-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>åŠ è½½è®°å½•ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æƒ³æ³•å‘å¸ƒå¡ç‰‡ -->
                    <div class="card thoughts-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-pencil"></i>
                            </div>
                            <h3 class="card-title">å‘å¸ƒæƒ³æ³•</h3>
                        </div>
                        
                        <div class="thought-input-container">
                            <img src="https://cdn.jsdelivr.net/gh/guoshijiang/picbed/2023/10/202310071352613.jpg" class="thought-avatar" alt="å¤´åƒ">
                            <div style="flex: 1;">
                                <textarea class="thought-input" id="new-thought" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•ã€å­¦ä¹ å¿ƒå¾—æˆ–æœ‰è¶£å‘ç°..."></textarea>
                                
                                <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
                                <div class="image-upload-container">
                                    <div class="image-upload-btn" onclick="document.getElementById('image-upload').click()">
                                        <i class="fa fa-image"></i>
                                        <span>æ·»åŠ å›¾ç‰‡</span>
                                    </div>
                                    <input type="file" id="image-upload" class="image-upload-input" accept="image/*" multiple onchange="handleImageUpload(event)">
                                    <p style="margin-top: 10px; color: #a0aec0; font-size: 0.9rem;">æ”¯æŒä¸Šä¼ JPGã€PNGæ ¼å¼ï¼Œæ¯å¼ å›¾ç‰‡ä¸è¶…è¿‡5MB</p>
                                </div>
                                
                                <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                                <div class="image-preview-container" id="image-preview-container">
                                    <!-- é¢„è§ˆå›¾ç‰‡å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; margin-top: 10px; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="clearThoughtInput()">
                                        <i class="fa fa-trash"></i> æ¸…ç©º
                                    </button>
                                    <button class="btn btn-primary" id="post-thought">
                                        <i class="fa fa-paper-plane"></i> å‘å¸ƒåˆ° GitHub
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <h4 class="history-title">å†å²æƒ³æ³•</h4>
                            <div class="thoughts-list" id="thoughts-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>åŠ è½½æƒ³æ³•ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <div id="footer-wrap">
                    <div class="copyright">&copy; 2023 ç™¾å¤œ | æ•°æ®å­˜å‚¨äº GitHub Issues</div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                        <a href="index.html" class="btn btn-secondary btn-small" style="text-decoration: none;">
                            <i class="fa fa-eye"></i> æŸ¥çœ‹å‰å°
                        </a>
                        <button class="btn btn-secondary btn-small" onclick="checkGitHubStatus()">
                            <i class="fa fa-info-circle"></i> GitHub çŠ¶æ€
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="logout()">
                            <i class="fa fa-sign-out"></i> é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </footer>
        </div>

        <!-- åŒæ­¥çŠ¶æ€æç¤º -->
        <div id="sync-status" class="sync-status" style="display: none;">
            <i class="fa fa-circle-o-notch fa-spin"></i> åŒæ­¥ä¸­...
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="image-viewer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center;">
        <div style="position: relative; max-width: 90%; max-height: 90%;">
            <img id="viewed-image" src="" alt="" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
            <button onclick="closeImageViewer()" style="position: absolute; top: -40px; right: 0; background: none; border: none; color: white; font-size: 2rem; cursor: pointer;">Ã—</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.fancybox@2.1.5/source/jquery.fancybox.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
    
    <script>
        // ==================== GitHub API å·¥å…·ç±» ====================
        class GitHubAPI {
            constructor(token, username, repo) {
                this.token = token;
                this.username = username;
                this.repo = repo;
                this.baseURL = 'https://api.github.com';
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                
                const headers = {
                    'Authorization': `token ${this.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    ...options.headers
                };

                try {
                    const response = await fetch(url, {
                        ...options,
                        headers
                    });

                    // æ£€æŸ¥å“åº”çŠ¶æ€
                    if (response.status === 401) {
                        throw new Error('Token å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
                    }

                    if (response.status === 403) {
                        const resetTime = response.headers.get('X-RateLimit-Reset');
                        if (resetTime) {
                            const resetDate = new Date(resetTime * 1000);
                            throw new Error(`API è¯·æ±‚å—é™ï¼Œå°†åœ¨ ${resetDate.toLocaleTimeString()} æ¢å¤`);
                        }
                        throw new Error('æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥ token æƒé™');
                    }

                    if (response.status === 404) {
                        throw new Error('ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®');
                    }

                    if (!response.ok) {
                        const error = await response.json().catch(() => ({}));
                        throw new Error(error.message || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    // æ£€æŸ¥é€Ÿç‡é™åˆ¶
                    const remaining = response.headers.get('X-RateLimit-Remaining');
                    const limit = response.headers.get('X-RateLimit-Limit');
                    
                    if (parseInt(remaining) < 10) {
                        showSyncStatus(`API è¯·æ±‚æ¬¡æ•°å³å°†ç”¨å®Œ (${remaining}/${limit})`, 'warning');
                    }

                    return response.json();
                } catch (error) {
                    console.error('GitHub API è¯·æ±‚å¤±è´¥:', error);
                    throw error;
                }
            }

            // æµ‹è¯•è¿æ¥
            async testConnection() {
                try {
                    const user = await this.request('/user');
                    const repo = await this.request(`/repos/${this.username}/${this.repo}`);
                    return {
                        success: true,
                        user: user.login,
                        repo: repo.name,
                        permissions: repo.permissions
                    };
                } catch (error) {
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            // åˆ›å»º Issue
            async createIssue(title, body, labels = []) {
                return this.request(`/repos/${this.username}/${this.repo}/issues`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        title, 
                        body, 
                        labels: [...labels, 'personal-blog']
                    })
                });
            }

            // è·å– Issues
            async getIssues(params = {}) {
                let endpoint = `/repos/${this.username}/${this.repo}/issues`;
                const queryParams = [];
                
                if (params.labels && params.labels.length > 0) {
                    queryParams.push(`labels=${params.labels.join(',')}`);
                }
                if (params.state) {
                    queryParams.push(`state=${params.state}`);
                }
                if (params.per_page) {
                    queryParams.push(`per_page=${params.per_page}`);
                }
                if (params.page) {
                    queryParams.push(`page=${params.page}`);
                }
                
                if (queryParams.length > 0) {
                    endpoint += `?${queryParams.join('&')}`;
                }
                
                return this.request(endpoint);
            }

            // è·å–ç”¨æˆ·çš„æ‰€æœ‰ä»“åº“
            async getUserRepos() {
                return this.request('/user/repos?per_page=100&sort=updated');
            }

            // åˆ›å»ºä»“åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            async createRepoIfNotExists() {
                try {
                    // å…ˆå°è¯•è·å–ä»“åº“
                    await this.request(`/repos/${this.username}/${this.repo}`);
                    return { created: false, message: 'ä»“åº“å·²å­˜åœ¨' };
                } catch (error) {
                    if (error.message.includes('404') || error.message.includes('ä¸å­˜åœ¨')) {
                        // ä»“åº“ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ä»“åº“
                        const newRepo = await this.request('/user/repos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: this.repo,
                                description: 'ä¸ªäººåšå®¢æ•°æ®å­˜å‚¨ä»“åº“',
                                private: true, // å»ºè®®è®¾ä¸ºç§æœ‰
                                auto_init: true,
                                has_issues: true,
                                has_wiki: false,
                                has_projects: false
                            })
                        });
                        return { created: true, repo: newRepo };
                    }
                    throw error;
                }
            }

            // è·å–ä»Šæ—¥å¿ƒæƒ…
            async getTodayMood() {
                const today = new Date().toISOString().split('T')[0];
                const issues = await this.getIssues({ 
                    labels: ['mood', 'personal-blog'],
                    per_page: 100 
                });
                
                return issues.find(issue => {
                    const issueDate = new Date(issue.created_at).toISOString().split('T')[0];
                    return issueDate === today;
                });
            }

            // ä¿å­˜ä»Šæ—¥å¿ƒæƒ…
            async saveTodayMood(content) {
                const todayMood = await this.getTodayMood();
                
                if (todayMood) {
                    // æ›´æ–°å·²æœ‰å¿ƒæƒ…
                    return this.updateIssue(todayMood.number, { body: content });
                } else {
                    // åˆ›å»ºæ–°å¿ƒæƒ…
                    const today = new Date().toLocaleDateString('zh-CN');
                    return this.createIssue(`å¿ƒæƒ…è®°å½• - ${today}`, content, ['mood']);
                }
            }

            // å‘å¸ƒæƒ³æ³•
            async postThought(content, images = []) {
                const timestamp = new Date().toLocaleString('zh-CN');
                const thoughtData = {
                    content,
                    timestamp,
                    images,
                    type: 'thought'
                };
                
                const title = content.length > 50 
                    ? content.substring(0, 47) + '...' 
                    : content;
                
                return this.createIssue(title, JSON.stringify(thoughtData, null, 2), ['thought']);
            }

            // è®°å½•ç•ªèŒ„é’Ÿå®Œæˆ
            async recordPomodoro(duration = 25, type = 'work') {
                const timestamp = new Date().toLocaleString('zh-CN');
                const pomodoroData = {
                    duration,
                    timestamp,
                    type,
                    completed: true
                };
                
                const title = `ç•ªèŒ„é’Ÿå®Œæˆ - ${type === 'work' ? 'ä¸“æ³¨' : 'ä¼‘æ¯'} ${duration}åˆ†é’Ÿ`;
                return this.createIssue(title, JSON.stringify(pomodoroData), ['pomodoro']);
            }

            // è·å–ç»Ÿè®¡æ•°æ®
            async getStatistics() {
                const [thoughts, pomodoros, moods] = await Promise.all([
                    this.getIssues({ labels: ['thought', 'personal-blog'], state: 'all', per_page: 1 }),
                    this.getIssues({ labels: ['pomodoro', 'personal-blog'], state: 'all', per_page: 1 }),
                    this.getIssues({ labels: ['mood', 'personal-blog'], state: 'all', per_page: 1 })
                ]);
                
                // æ³¨æ„ï¼šè¿™é‡Œè·å–çš„æ˜¯ç¬¬ä¸€é¡µï¼Œä»…ç”¨äºè®¡æ•°
                // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦è·å–æ‰€æœ‰æ•°æ®æ¥å‡†ç¡®è®¡æ•°
                
                return {
                    thoughts: thoughts.length,
                    pomodoros: pomodoros.length,
                    moods: moods.length
                };
            }

            // æ›´æ–° Issue
            async updateIssue(issueNumber, updates) {
                return this.request(`/repos/${this.username}/${this.repo}/issues/${issueNumber}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
            }
        }

        // ==================== å…¨å±€å˜é‡å’Œé…ç½® ====================
        const CONFIG = {
            // ä½ çš„ GitHub OAuth App Client ID
            clientId: 'YOUR_GITHUB_CLIENT_ID',
            // é»˜è®¤ä»“åº“åï¼ˆç”¨æˆ·å¯ä¿®æ”¹ï¼‰
            defaultRepo: 'personal-blog-data',
            // API ç«¯ç‚¹ï¼ˆéƒ¨ç½²åä¿®æ”¹ä¸ºä½ çš„ Vercel URLï¼‰
            apiEndpoint: window.location.origin.includes('localhost') 
                ? 'http://localhost:3000/api/github-auth'
                : 'ä½ çš„_VERCEL_URL/api/github-auth'
        };

        let githubAPI = null;
        let currentUser = null;
        let currentRepo = null;
        let uploadedImages = [];

        // ==================== OAuth ç›¸å…³å‡½æ•° ====================
        function githubLogin() {
            const authUrl = `https://github.com/login/oauth/authorize?client_id=${CONFIG.clientId}&redirect_uri=${encodeURIComponent(window.location.href)}&scope=repo`;
            window.location.href = authUrl;
        }

        async function exchangeCodeForToken(code) {
            showSyncStatus('æ­£åœ¨äº¤æ¢æˆæƒç ...', 'info');
            
            try {
                const response = await fetch(`${CONFIG.apiEndpoint}?code=${code}`);
                const data = await response.json();
                
                if (data.access_token) {
                    // ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
                    localStorage.setItem('github_access_token', data.access_token);
                    localStorage.setItem('github_user', JSON.stringify(data.user));
                    
                    // æ¸…é™¤ URL ä¸­çš„ code å‚æ•°
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    showSyncStatus('æˆæƒæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error(data.error || 'æˆæƒå¤±è´¥');
                }
            } catch (error) {
                console.error('è·å– token å¤±è´¥:', error);
                showSyncStatus('æˆæƒå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ==================== åº”ç”¨åˆå§‹åŒ–å‡½æ•° ====================
        async function initializeApp() {
            showSyncStatus('åˆå§‹åŒ–åº”ç”¨ä¸­...', 'info');
            
            try {
                // è·å–ç”¨æˆ·ä¿¡æ¯
                const userStr = localStorage.getItem('github_user');
                if (!userStr) throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨');
                
                currentUser = JSON.parse(userStr);
                displayUserInfo(currentUser);
                
                // åˆå§‹åŒ– GitHub API
                const token = localStorage.getItem('github_access_token');
                if (!token) throw new Error('Token ä¸å­˜åœ¨');
                
                // è·å–ä»“åº“åˆ—è¡¨
                const tempAPI = new GitHubAPI(token, currentUser.login, 'temp');
                const repos = await tempAPI.getUserRepos();
                
                // å¡«å……ä»“åº“é€‰æ‹©å™¨
                const repoSelect = document.getElementById('repo-select');
                repoSelect.innerHTML = '<option value="">é€‰æ‹©ä»“åº“...</option>';
                repos.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.name;
                    option.textContent = repo.name + (repo.private ? ' ğŸ”’' : '');
                    if (repo.name === CONFIG.defaultRepo) {
                        option.selected = true;
                        currentRepo = repo.name;
                    }
                    repoSelect.appendChild(option);
                });
                
                repoSelect.addEventListener('change', async (e) => {
                    currentRepo = e.target.value;
                    if (currentRepo) {
                        await initGitHubAPI();
                        await loadAllData();
                    }
                });
                
                if (currentRepo) {
                    await initGitHubAPI();
                    await loadAllData();
                }
                
                showSyncStatus('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showSyncStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function initGitHubAPI() {
            const token = localStorage.getItem('github_access_token');
            if (!token || !currentUser || !currentRepo) {
                throw new Error('ç¼ºå°‘å¿…è¦ä¿¡æ¯');
            }
            
            githubAPI = new GitHubAPI(token, currentUser.login, currentRepo);
            
            // æµ‹è¯•è¿æ¥
            const result = await githubAPI.testConnection();
            if (!result.success) {
                // å°è¯•åˆ›å»ºä»“åº“
                if (result.error.includes('ä¸å­˜åœ¨')) {
                    showSyncStatus('ä»“åº“ä¸å­˜åœ¨ï¼Œå°è¯•åˆ›å»º...', 'warning');
                    try {
                        await githubAPI.createRepoIfNotExists();
                        showSyncStatus('ä»“åº“åˆ›å»ºæˆåŠŸï¼', 'success');
                    } catch (createError) {
                        throw new Error('åˆ›å»ºä»“åº“å¤±è´¥: ' + createError.message);
                    }
                } else {
                    throw new Error('è¿æ¥æµ‹è¯•å¤±è´¥: ' + result.error);
                }
            }
        }

        // ==================== æ•°æ®æ“ä½œå‡½æ•° ====================
        async function loadAllData() {
            if (!githubAPI) return;
            
            showSyncStatus('åŠ è½½æ•°æ®ä¸­...', 'info');
            
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadTodayMood(),
                    loadThoughts(),
                    loadPomodoroData(),
                    loadStatistics()
                ]);
                
                showSyncStatus('æ•°æ®åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showSyncStatus('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadTodayMood() {
            if (!githubAPI) return;
            
            try {
                const todayMood = await githubAPI.getTodayMood();
                const moodEditor = document.getElementById('mood-editor');
                
                if (todayMood) {
                    moodEditor.innerHTML = todayMood.body.replace(/\n/g, '<br>');
                    moodEditor.classList.remove('mood-placeholder');
                } else {
                    moodEditor.innerHTML = 'ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...';
                    moodEditor.classList.add('mood-placeholder');
                }
            } catch (error) {
                console.error('åŠ è½½å¿ƒæƒ…å¤±è´¥:', error);
            }
        }

        async function loadThoughts() {
            if (!githubAPI) return;
            
            try {
                const thoughts = await githubAPI.getIssues({ 
                    labels: ['thought', 'personal-blog'],
                    per_page: 20 
                });
                const thoughtsList = document.getElementById('thoughts-list');
                
                if (thoughts.length === 0) {
                    thoughtsList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #a0aec0;">
                            <i class="fa fa-pencil" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <p>è¿˜æ²¡æœ‰å‘å¸ƒä»»ä½•æƒ³æ³•</p>
                            <p style="font-size: 0.9rem; margin-top: 10px;">å†™ä¸‹ä½ çš„ç¬¬ä¸€ä»½æ€è€ƒå§ï¼</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                thoughts.forEach(issue => {
                    const createTime = new Date(issue.created_at).toLocaleString('zh-CN');
                    let thoughtData;
                    try {
                        thoughtData = JSON.parse(issue.body || '{}');
                    } catch (e) {
                        thoughtData = { content: issue.body || issue.title };
                    }
                    
                    let imagesHtml = '';
                    if (thoughtData.images && thoughtData.images.length > 0) {
                        imagesHtml = '<div class="thought-images">';
                        thoughtData.images.forEach((img, index) => {
                            imagesHtml += `
                                <div class="thought-image-item" onclick="viewImage('${img}')">
                                    <img src="${img}" alt="å›¾ç‰‡${index + 1}">
                                </div>
                            `;
                        });
                        imagesHtml += '</div>';
                    }
                    
                    html += `
                        <div class="thought-item">
                            <div class="thought-header">
                                <img src="${currentUser.avatar_url}" class="thought-avatar" alt="${currentUser.login}">
                                <div>
                                    <div class="thought-author">${currentUser.name || currentUser.login}</div>
                                    <div class="thought
