<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5">
    <title>åå°ç®¡ç† | ç™¾å¤œ</title>
    <meta name="description" content="åå°ç®¡ç†é¡µé¢">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- åå°ç‰¹æœ‰æ ·å¼ -->
    <style>
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .github-auth-card {
            max-width: 400px;
            width: 100%;
            background: rgba(25, 30, 40, 0.95);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            border: 1px solid rgba(103, 81, 185, 0.5);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .auth-icon {
            font-size: 4rem;
            color: #6751b9;
            margin-bottom: 20px;
        }
        
        .auth-title {
            font-size: 1.8rem;
            color: #fff;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            color: #a0aec0;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .auth-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 15px 30px;
            background: #24292e;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .auth-btn:hover {
            background: #2c3138;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(36, 41, 46, 0.3);
        }
        
        .user-info-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(103, 81, 185, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(103, 81, 185, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(103, 81, 185, 0.5);
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(25, 30, 40, 0.95);
            border-radius: 10px;
            padding: 12px 18px;
            font-size: 14px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid transparent;
            transition: all 0.3s;
        }
        
        .sync-status.success {
            border-color: #10b981;
            color: #10b981;
        }
        
        .sync-status.error {
            border-color: #ef4444;
            color: #ef4444;
        }
        
        .sync-status.info {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 20, 30, 0.6);
            color: #e8eaed;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: rgba(103, 81, 185, 0.2);
            border-color: rgba(103, 81, 185, 0.5);
        }
        
        .data-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(15, 20, 30, 0.6);
            border-radius: 8px;
        }
        
        .data-stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #8a74f9;
            margin-bottom: 5px;
        }
        
        .data-stat-label {
            font-size: 0.85rem;
            color: #a0aec0;
        }
        
        .repo-selector {
            margin-top: 15px;
        }
        
        .repo-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            background: rgba(15, 20, 30, 0.6);
            border: 1px solid rgba(103, 81, 185, 0.3);
            color: #e8eaed;
            font-size: 14px;
        }
        
        .repo-select:focus {
            outline: none;
            border-color: #6751b9;
        }
    </style>
</head>

<body>
    <!-- æˆæƒç™»å½•ç•Œé¢ -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="github-auth-card">
            <div class="auth-icon">
                <i class="fa fa-github"></i>
            </div>
            <h2 class="auth-title">GitHub æˆæƒ</h2>
            <p class="auth-subtitle">
                éœ€è¦ GitHub æˆæƒæ¥ç®¡ç†ä½ çš„æ•°æ®<br>
                æ•°æ®å°†å®‰å…¨å­˜å‚¨åœ¨ä½ çš„ GitHub Issues ä¸­
            </p>
            <button class="auth-btn" onclick="githubLogin()">
                <i class="fa fa-github"></i> ä½¿ç”¨ GitHub ç™»å½•
            </button>
            <p class="auth-note" style="color: #a0aec0; font-size: 12px; margin-top: 20px;">
                æˆæƒåï¼Œä½ å¯ä»¥åœ¨ä½ çš„ GitHub ä»“åº“ Issues ä¸­<br>
                æŸ¥çœ‹å’Œç®¡ç†æ‰€æœ‰æ•°æ®è®°å½•
            </p>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div id="app-container" style="display: none;">
        <div id="body-wrap">
            <!-- å¯¼èˆªæ  -->
            <nav>
                <div id="site-title">
                    <span class="blogtitle">åå°ç®¡ç† | ç™¾å¤œ</span>
                </div>
                <div style="position: absolute; top: 10px; right: 20px;">
                    <div class="user-info-bar" id="user-info">
                        <!-- ç”¨æˆ·ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </nav>

            <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
            <div class="layout_container">
                <!-- ä¾§è¾¹æ  -->
                <div class="aside_content">
                    <!-- ä¸ªäººèµ„æ–™å¡ç‰‡ -->
                    <div class="card profile-card">
                        <div class="profile-avatar">
                            <img src="https://images3.alphacoders.com/135/thumb-1920-1358482.png" alt="å¤´åƒ">
                        </div>
                        <h2 class="profile-name">æ‘¸é±¼çˆ±å¥½è€…</h2>
                        <p class="profile-bio">SYSUæ•°å­¦ç³»å¤§ä¸‰åœ¨è¯»<br>äºŒæ¬¡å…ƒçˆ±å¥½è€… | å‰ç«¯å¼€å‘è€…<br>æ°¸è¿œä¿æŒæ±‚çŸ¥æ¬²</p>
                        
                        <div class="profile-tags">
                            <span class="tag">æ•°å­¦</span>
                            <span class="tag">ç¼–ç¨‹</span>
                            <span class="tag">äºŒæ¬¡å…ƒ</span>
                        </div>
                        
                        <div class="social-links">
                            <a href="index.html" class="social-link" title="æŸ¥çœ‹å‰å°">
                                <i class="fa fa-eye"></i>
                            </a>
                            <a href="#" class="social-link" title="GitHub">
                                <i class="fa fa-github"></i>
                            </a>
                        </div>
                    </div>

                    <!-- ä»“åº“é€‰æ‹© -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-database"></i>
                            </div>
                            <h3 class="card-title">æ•°æ®ä»“åº“</h3>
                        </div>
                        <div class="repo-selector">
                            <select class="repo-select" id="repo-select">
                                <option value="">é€‰æ‹©ä»“åº“...</option>
                            </select>
                        </div>
                        <div class="data-stats">
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-thoughts">0</div>
                                <div class="data-stat-label">æƒ³æ³•è®°å½•</div>
                            </div>
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-pomodoros">0</div>
                                <div class="data-stat-label">ç•ªèŒ„é’Ÿ</div>
                            </div>
                            <div class="data-stat-item">
                                <div class="data-stat-value" id="stats-moods">0</div>
                                <div class="data-stat-label">å¿ƒæƒ…è®°å½•</div>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="loadAllData()">
                                <i class="fa fa-refresh"></i> åˆ·æ–°æ•°æ®
                            </button>
                            <button class="action-btn" onclick="exportData()">
                                <i class="fa fa-download"></i> å¯¼å‡ºæ•°æ®
                            </button>
                        </div>
                    </div>

                    <!-- å¿ƒæƒ…ç¼–è¾‘å¡ç‰‡ -->
                    <div class="card mood-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-heart"></i>
                            </div>
                            <h3 class="card-title">ä»Šæ—¥å¿ƒæƒ…</h3>
                        </div>
                        <div 
                            class="mood-content" 
                            id="mood-editor" 
                            contenteditable="true"
                            data-placeholder="ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…..."
                        >ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...</div>
                        <div class="mood-actions">
                            <button class="mood-btn" onclick="clearMood()">
                                <i class="fa fa-trash"></i> æ¸…ç©º
                            </button>
                            <button class="mood-btn mood-btn-primary" onclick="saveMood()">
                                <i class="fa fa-save"></i> ä¿å­˜åˆ° GitHub
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ä¸»å†…å®¹åŒº -->
                <div class="main_content">
                    <!-- ç•ªèŒ„é’ŸåŠŸèƒ½å¡ç‰‡ -->
                    <div class="card pomodoro-card">
                        <div class="pomodoro-header">
                            <div class="card-header">
                                <div class="card-icon">
                                    <i class="fa fa-clock-o"></i>
                                </div>
                                <h3 class="card-title">å­¦æœ¯ç•ªèŒ„é’Ÿ</h3>
                            </div>
                            <div class="timer-status" id="timer-status">å‡†å¤‡å¼€å§‹</div>
                        </div>
                        
                        <div class="pomodoro-timer">
                            <div class="timer-display" id="timer-display">25:00</div>
                        </div>
                        
                        <div class="controls-grid">
                            <button class="btn btn-primary" id="start-btn">
                                <i class="fa fa-play"></i> å¼€å§‹ä¸“æ³¨
                            </button>
                            <button class="btn btn-secondary" id="pause-btn" style="display:none">
                                <i class="fa fa-pause"></i> æš‚åœ
                            </button>
                            <button class="btn btn-secondary" id="reset-btn">
                                <i class="fa fa-refresh"></i> é‡ç½®
                            </button>
                            <button class="btn btn-secondary btn-small" id="short-break">
                                <i class="fa fa-coffee"></i> çŸ­ä¼‘æ¯
                            </button>
                            <button class="btn btn-secondary btn-small" id="long-break">
                                <i class="fa fa-bed"></i> é•¿ä¼‘æ¯
                            </button>
                        </div>
                        
                        <div class="pomodoro-history">
                            <h4 class="history-title">ä»Šæ—¥ä¸“æ³¨è®°å½•</h4>
                            <div class="history-list" id="history-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>åŠ è½½è®°å½•ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æƒ³æ³•å‘å¸ƒå¡ç‰‡ -->
                    <div class="card thoughts-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fa fa-pencil"></i>
                            </div>
                            <h3 class="card-title">å‘å¸ƒæƒ³æ³•</h3>
                        </div>
                        
                        <div class="thought-input-container">
                            <div style="flex: 1;">
                                <textarea class="thought-input" id="new-thought" placeholder="åˆ†äº«ä½ çš„æƒ³æ³•ã€å­¦ä¹ å¿ƒå¾—æˆ–æœ‰è¶£å‘ç°..."></textarea>
                                
                                <div style="display: flex; justify-content: flex-end; margin-top: 10px; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="clearThoughtInput()">
                                        <i class="fa fa-trash"></i> æ¸…ç©º
                                    </button>
                                    <button class="btn btn-primary" id="post-thought">
                                        <i class="fa fa-paper-plane"></i> å‘å¸ƒåˆ° GitHub
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <h4 class="history-title">å†å²æƒ³æ³•</h4>
                            <div class="thoughts-list" id="thoughts-list">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>åŠ è½½æƒ³æ³•ä¸­...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer>
                <div id="footer-wrap">
                    <div class="copyright">&copy; 2023 ç™¾å¤œ | æ•°æ®å­˜å‚¨äº GitHub Issues</div>
                    <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                        <a href="index.html" class="btn btn-secondary btn-small" style="text-decoration: none;">
                            <i class="fa fa-eye"></i> æŸ¥çœ‹å‰å°
                        </a>
                        <button class="btn btn-secondary btn-small" onclick="checkGitHubStatus()">
                            <i class="fa fa-info-circle"></i> GitHub çŠ¶æ€
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="logout()">
                            <i class="fa fa-sign-out"></i> é€€å‡ºç™»å½•
                        </button>
                    </div>
                </div>
            </footer>
        </div>

        <!-- åŒæ­¥çŠ¶æ€æç¤º -->
        <div id="sync-status" class="sync-status" style="display: none;">
            <i class="fa fa-circle-o-notch fa-spin"></i> åŒæ­¥ä¸­...
        </div>
    </div>

    <!-- å¤–éƒ¨ JS åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
    
    <!-- é¡¹ç›® JS æ–‡ä»¶ -->
    <script src="js/github-api.js"></script>
    <script src="js/github-auth.js"></script>
    <script src="js/main.js"></script>
    <script src="js/thoughts.js"></script>
    <script src="js/pomodoro.js"></script>
    
    <!-- åå°é¡µé¢åˆå§‹åŒ– -->
    <script>
        // å…¨å±€å˜é‡
        let githubAPI = null;
        let currentUser = null;
        let currentRepo = null;
        
       // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æˆæƒ
document.addEventListener('DOMContentLoaded', async function() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');

    if (code) {
        // æ˜¾ç¤ºåŠ è½½ç•Œé¢
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'none';

        // å¼€å§‹äº¤æ¢ token
        const result = await exchangeCodeForToken(code);

        if (result.success) {
            // ç™»å½•æˆåŠŸåæ¸…é™¤ code
            window.history.replaceState({}, document.title, window.location.pathname);

            currentUser = result.user;

            // æ˜¾ç¤ºä¸»ç•Œé¢
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            displayUserInfo(currentUser);

            // åˆå§‹åŒ–åå°
            initializeApp();
        } else {
            alert("ç™»å½•å¤±è´¥ï¼š" + result.error);

            // æ˜¾ç¤ºé‡æ–°ç™»å½•æŒ‰é’®
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }

    } else {
        // æ²¡æœ‰ code â†’ æŸ¥çœ‹æ˜¯å¦å·²ç»ç™»å½•
        const authStatus = checkAuthStatus();

        if (authStatus.isLoggedIn) {
            currentUser = authStatus.user;

            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            displayUserInfo(currentUser);
            initializeApp();
        } else {
            // æœªç™»å½• â†’ æ˜¾ç¤ºç™»å½•é¡µé¢
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
    }
});
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        function displayUserInfo(user) {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <img src="${user.avatar_url}" class="user-avatar" alt="${user.login}">
                <div style="flex: 1;">
                    <div style="font-weight: bold; color: #fff;">${user.name || user.login}</div>
                    <div style="font-size: 12px; color: #a0aec0;">${user.login}</div>
                </div>
                <div style="font-size: 12px; color: #a0aec0; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px;">
                    GitHub
                </div>
            `;
        }
        
        // æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
        function showSyncStatus(message, type = 'info') {
            const statusDiv = document.getElementById('sync-status');
            statusDiv.innerHTML = '';
            
            let icon = 'fa-circle-o-notch fa-spin';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            
            statusDiv.innerHTML = `<i class="fa ${icon}"></i> ${message}`;
            statusDiv.className = `sync-status ${type}`;
            statusDiv.style.display = 'flex';
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // åº”ç”¨åˆå§‹åŒ–
        async function initializeApp() {
            showSyncStatus('åˆå§‹åŒ–åº”ç”¨ä¸­...', 'info');
            
            try {
                // è·å–ä»“åº“åˆ—è¡¨
                const token = localStorage.getItem('github_access_token');
                const tempAPI = new GitHubAPI(token, currentUser.login, 'temp');
                const repos = await tempAPI.getUserRepos();
                
                // å¡«å……ä»“åº“é€‰æ‹©å™¨
                const repoSelect = document.getElementById('repo-select');
                repoSelect.innerHTML = '<option value="">é€‰æ‹©ä»“åº“...</option>';
                repos.forEach(repo => {
                    const option = document.createElement('option');
                    option.value = repo.name;
                    option.textContent = repo.name + (repo.private ? ' ğŸ”’' : '');
                    if (repo.name === 'personal-blog-data') {
                        option.selected = true;
                        currentRepo = repo.name;
                    }
                    repoSelect.appendChild(option);
                });
                
                repoSelect.addEventListener('change', async (e) => {
                    currentRepo = e.target.value;
                    if (currentRepo) {
                        await initGitHubAPI();
                        await loadAllData();
                    }
                });
                
                if (currentRepo) {
                    await initGitHubAPI();
                    await loadAllData();
                }
                
                // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
                document.getElementById('start-btn').addEventListener('click', pomodoroManager.start);
                document.getElementById('pause-btn').addEventListener('click', pomodoroManager.pause);
                document.getElementById('reset-btn').addEventListener('click', pomodoroManager.reset);
                document.getElementById('short-break').addEventListener('click', () => pomodoroManager.setBreak(5));
                document.getElementById('long-break').addEventListener('click', () => pomodoroManager.setBreak(15));
                
                document.getElementById('post-thought').addEventListener('click', postThought);
                
                // å…è®¸ Ctrl+Enter å‘å¸ƒæƒ³æ³•
                document.getElementById('new-thought').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        postThought();
                    }
                });
                
                showSyncStatus('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showSyncStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function initGitHubAPI() {
            const token = localStorage.getItem('github_access_token');
            if (!token || !currentUser || !currentRepo) {
                throw new Error('ç¼ºå°‘å¿…è¦ä¿¡æ¯');
            }
            
            githubAPI = new GitHubAPI(token, currentUser.login, currentRepo);
            
            // æµ‹è¯•è¿æ¥
            const result = await githubAPI.testConnection();
            if (!result.success) {
                throw new Error('è¿æ¥æµ‹è¯•å¤±è´¥: ' + result.error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            if (!githubAPI) return;
            
            showSyncStatus('åŠ è½½æ•°æ®ä¸­...', 'info');
            
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadTodayMood(),
                    loadThoughts(),
                    loadPomodoroData(),
                    loadStatistics()
                ]);
                
                showSyncStatus('æ•°æ®åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showSyncStatus('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function loadTodayMood() {
            if (!githubAPI) return;
            
            try {
                const todayMood = await githubAPI.getTodayMood();
                const moodEditor = document.getElementById('mood-editor');
                
                if (todayMood) {
                    moodEditor.innerHTML = todayMood.body.replace(/\n/g, '<br>');
                    moodEditor.classList.remove('mood-placeholder');
                } else {
                    moodEditor.innerHTML = 'ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...';
                    moodEditor.classList.add('mood-placeholder');
                }
            } catch (error) {
                console.error('åŠ è½½å¿ƒæƒ…å¤±è´¥:', error);
            }
        }
        
        async function loadThoughts() {
            if (!githubAPI) return;
            
            try {
                const thoughts = await githubAPI.getIssues({ 
                    labels: ['thought', 'personal-blog'],
                    per_page: 20 
                });
                
                thoughtsManager.displayThoughts(thoughts, 'thoughts-list');
            } catch (error) {
                console.error('åŠ è½½æƒ³æ³•å¤±è´¥:', error);
            }
        }
        
        async function loadPomodoroData() {
            if (!githubAPI) return;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const pomodoros = await githubAPI.getIssues({ 
                    labels: ['pomodoro', 'personal-blog'],
                    per_page: 50 
                });
                
                const todayRecords = pomodoros.filter(issue => {
                    const issueDate = new Date(issue.created_at).toISOString().split('T')[0];
                    return issueDate === today;
                });
                
                const historyList = document.getElementById('history-list');
                if (todayRecords.length === 0) {
                    historyList.innerHTML = '<div class="history-item">ä»Šå¤©è¿˜æ²¡æœ‰è®°å½•</div>';
                } else {
                    let html = '';
                    todayRecords.slice(0, 5).forEach(issue => {
                        const time = new Date(issue.created_at).toLocaleTimeString('zh-CN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        html += `
                            <div class="history-item">
                                <i class="fa fa-check-circle" style="color:#4ade80; margin-right:8px;"></i>
                                ${time} - å®Œæˆ25åˆ†é’Ÿä¸“æ³¨
                            </div>
                        `;
                    });
                    historyList.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½ç•ªèŒ„é’Ÿæ•°æ®å¤±è´¥:', error);
            }
        }
        
        async function loadStatistics() {
            if (!githubAPI) return;
            
            try {
                const stats = await githubAPI.getStatistics();
                document.getElementById('stats-thoughts').textContent = stats.thoughts;
                document.getElementById('stats-pomodoros').textContent = stats.pomodoros;
                document.getElementById('stats-moods').textContent = stats.moods;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜å¿ƒæƒ…
        async function saveMood() {
            if (!githubAPI) {
                showSyncStatus('è¯·å…ˆé€‰æ‹©ä»“åº“', 'error');
                return;
            }
            
            const moodEditor = document.getElementById('mood-editor');
            const content = moodEditor.innerText.trim();
            
            if (!content || content === 'ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...') {
                showSyncStatus('è¯·è¾“å…¥å¿ƒæƒ…å†…å®¹', 'warning');
                return;
            }
            
            try {
                showSyncStatus('ä¿å­˜å¿ƒæƒ…ä¸­...', 'info');
                await githubAPI.saveTodayMood(content);
                showSyncStatus('å¿ƒæƒ…ä¿å­˜æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¿å­˜å¿ƒæƒ…å¤±è´¥:', error);
                showSyncStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å‘å¸ƒæƒ³æ³•
        async function postThought() {
            if (!githubAPI) {
                showSyncStatus('è¯·å…ˆé€‰æ‹©ä»“åº“', 'error');
                return;
            }
            
            const content = document.getElementById('new-thought').value.trim();
            if (!content) {
                showSyncStatus('è¯·è¾“å…¥å†…å®¹', 'warning');
                return;
            }
            
            try {
                showSyncStatus('å‘å¸ƒæƒ³æ³•ä¸­...', 'info');
                await githubAPI.postThought(content);
                
                // æ¸…ç©ºè¾“å…¥
                document.getElementById('new-thought').value = '';
                
                showSyncStatus('æƒ³æ³•å‘å¸ƒæˆåŠŸï¼', 'success');
                await loadThoughts();
            } catch (error) {
                console.error('å‘å¸ƒå¤±è´¥:', error);
                showSyncStatus('å‘å¸ƒå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æ¸…ç©ºå¿ƒæƒ…
        function clearMood() {
            const moodEditor = document.getElementById('mood-editor');
            moodEditor.innerHTML = 'ç‚¹å‡»è¿™é‡Œè®°å½•ä»Šå¤©çš„å¿ƒæƒ…...';
            moodEditor.classList.add('mood-placeholder');
        }
        
        // æ¸…ç©ºæƒ³æ³•è¾“å…¥
        function clearThoughtInput() {
            document.getElementById('new-thought').value = '';
        }
        
        // æ£€æŸ¥ GitHub çŠ¶æ€
        async function checkGitHubStatus() {
            if (!githubAPI) {
                showSyncStatus('æœªè¿æ¥åˆ° GitHub', 'warning');
                return;
            }
            
            try {
                const result = await githubAPI.testConnection();
                if (result.success) {
                    showSyncStatus(`è¿æ¥æ­£å¸¸ | ${result.user} / ${result.repo}`, 'success');
                } else {
                    showSyncStatus('è¿æ¥å¼‚å¸¸: ' + result.error, 'error');
                }
            } catch (error) {
                showSyncStatus('æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // å¯¼å‡ºæ•°æ®
        async function exportData() {
            if (!githubAPI) {
                showSyncStatus('è¯·å…ˆç™»å½•å¹¶é€‰æ‹©ä»“åº“', 'error');
                return;
            }
            
            try {
                showSyncStatus('å¯¼å‡ºæ•°æ®ä¸­...', 'info');
                
                // è·å–æ‰€æœ‰æ•°æ®
                const [thoughts, pomodoros, moods] = await Promise.all([
                    githubAPI.getIssues({ labels: ['thought', 'personal-blog'], state: 'all', per_page: 1000 }),
                    githubAPI.getIssues({ labels: ['pomodoro', 'personal-blog'], state: 'all', per_page: 1000 }),
                    githubAPI.getIssues({ labels: ['mood', 'personal-blog'], state: 'all', per_page: 1000 })
                ]);
                
                const exportData = {
                    exportDate: new Date().toISOString(),
                    thoughts,
                    pomodoros,
                    moods
                };
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `github-issues-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showSyncStatus('æ•°æ®å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showSyncStatus('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç™»å‡º
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('github_access_token');
                localStorage.removeItem('github_user');
                window.location.reload();
            }
        }
    </script>
</body>
</html>
